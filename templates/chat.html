{% extends 'base.html' %}

{% block content %}

<div class="boxed">
    <div>
        <main class="user-chat">
            <div class="msg left-msg">
                <div class="msg-bubble">
                    <div class="msg-info">
                        <div class="msg-info-name">Dicer</div>
                        <div class="msg-info-time">12:45</div>
                    </div>
                    <div class="msg-text" markdown="1">
                        Hi, what do you want to dine today? ðŸ˜„
                    </div>
                </div>
            </div>
        </main>
        <form class="user-input-form">
            <input type="text" class="user-input" id="text-input" placeholder="Tell me your thoughts"/>
            <button type="submit" class="user-send-btn">Send</button>
        </form>
    </div>
    <script>
        const userInputForm = get(".user-input-form");
        const userInput = get(".user-input");
        const userChat = get(".user-chat");

        const BOT_NAME = "    Dicer";
        const PERSON_NAME = "You";

        userInputForm.addEventListener("submit", event => {
            console.log("submitted!")
            event.preventDefault();
            const msgText = userInput.value;
            if (!msgText) return;
            appendMessage(PERSON_NAME, "right", msgText);
            userInput.value = "";
            botResponse(msgText);
        });

        function appendMessage(name, side, text) {
            const msgHTML = `
            <div class="msg ${side}-msg">
                <div class="msg-bubble">
                    <div class="msg-info">
                        <div class="msg-info-name">${name}</div>
                        <div class="msg-info-time">${formatDate(new Date())}</div>
                    </div>
                <div class="msg-text">${text}</div>
                </div>
            </div>
            `;
            userChat.insertAdjacentHTML("beforeend", msgHTML);
            userChat.scrollTop += 500;
        }

        function botResponse(rawText) {
            console.log("called bot response!");
            // Bot Response
            $.get("/get_response", { msg: rawText }).done(function (data) {
                console.log(rawText);
                console.log(data);
                const msgText = data;
                appendMessage(BOT_NAME, "left", msgText);
            });
        }

        function get(selector, root = document) {
            return root.querySelector(selector);
        }

        function formatDate(date) {
            const h = "0" + date.getHours();
            const m = "0" + date.getMinutes();
            return `${h.slice(-2)}:${m.slice(-2)}`;
        }
    </script>
</div>
{% endblock %}